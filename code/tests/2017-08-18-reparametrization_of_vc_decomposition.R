#' ---
#' title: "Reparametrization of Vaupel-Romo decomposition"
#' author: "Jonas Sch√∂ley"
#' date: "August 18, 2017"
#' ---

library(tidyverse)

##'# Stratified perinatal life-table

ilt <- structure(list(
  id =
    c(1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 2L,
      2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L,
      3L, 4L, 4L, 4L, 4L, 4L, 4L, 4L, 4L, 4L),
  congenital_anomalies =
    structure(c(1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L,
                2L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 4L, 4L, 4L, 4L, 4L, 4L,
                4L, 4L, 4L),
              .Label = c("None", "Least severe", "Less severe",
                         "Severe"), class = "factor"),
  x =
    c(0, 1, 24, 48, 72, 96, 120, 144, 168, 0, 1, 24, 48, 72, 96, 120, 144, 168,
      0, 1, 24, 48, 72, 96, 120, 144, 168, 0, 1, 24, 48, 72, 96, 120, 144, 168),
  lx_z =
    c(1, 0.999, 0.998, 0.997, 0.997, 0.997, 0.997, 0.997,
      0.997, 1, 0.997, 0.991, 0.989, 0.987, 0.986, 0.985, 0.985,
      0.984, 1, 0.996, 0.987, 0.986, 0.985, 0.984, 0.983, 0.983,
      0.983, 1, 0.973, 0.923, 0.914, 0.908, 0.905, 0.901, 0.899,
      0.897),
  mux_z =
    c(0.000501, 0.000182, 4.21e-06, 2.91e-06, 2.03e-06, 1.37e-06, 1.07e-06,
      9.47e-07, 9.52e-07, 0.0015, 0.000591, 2.89e-05, 2.53e-05, 1.79e-05,
      1.43e-05, 9.42e-06, 7.52e-06, 1.13e-05, 0.00184, 0.000781, 3.64e-05,
      1.69e-05, 1.54e-05, 8.92e-06, 5.61e-06, 4.79e-06, 2.15e-06, 0.015,
      0.00549, 0.000187, 9.8e-05, 6.57e-05, 4.82e-05, 4.11e-05, 3.4e-05,
      2.41e-05),
  dmux_z =
    c(-0.000722, -0.000135, -2.16e-07, -6.45e-10, -4.89e-08, -1.4e-08,
      -1.08e-08, -1.2e-09, 1.23e-09, -0.00205, -0.000391, -1.13e-06,
      1.18e-07, -4.7e-07, 3.88e-08, -3.5e-07, 1.12e-07, 1.84e-07, -0.00227,
      -0.000483, -1.69e-06, -3.86e-07, 8.79e-08, -4.54e-07, 7.14e-08,
      -1.07e-07, -1.09e-07, -0.0216, -0.00403, -7.21e-06, -1.91e-06,
      -9.46e-07, -5.59e-07, -1.19e-07, -4.11e-07, -4.04e-07),
  pxz =
    c(0.997, 0.996, 0.994, 0.994, 0.994, 0.994, 0.994, 0.994, 0.994, 0.00066,
      0.000659, 0.000654, 0.000653, 0.000652, 0.000651, 0.000651, 0.00065,
      0.00065, 0.000801, 0.000798, 0.000791, 0.000789, 0.000788,
      0.000788, 0.000787, 0.000787, 0.000787, 0.00169, 0.00165,
      0.00156, 0.00155, 0.00154, 0.00153, 0.00153, 0.00152, 0.00152
    ),
  pz_x =
    c(0.997, 0.997, 0.997, 0.997, 0.997, 0.997, 0.997, 0.997, 0.997, 0.00066,
      0.000659, 0.000656, 0.000655, 0.000654, 0.000653, 0.000653, 0.000653,
      0.000652, 0.000801, 0.000799, 0.000793, 0.000792, 0.000791, 0.00079,
      0.00079, 0.00079, 0.000789, 0.00169, 0.00165, 0.00157, 0.00155,
      0.00154, 0.00154, 0.00153, 0.00153, 0.00152)),
  .Names =
    c("id", "congenital_anomalies", "x", "lx_z", "mux_z", "dmux_z", "pxz", "pz_x"),
  class =
    c("tbl_df", "tbl", "data.frame"), row.names = c(NA, -36L)
)

##'# Vaupel-Romo decomposition

#' Based on the probability to be in strata $z$ and age $x$.

ilt %>%
  group_by(x) %>%
  summarise(
    mux = sum(mux_z * pxz) / sum(pxz),
    direct_fx = sum(dmux_z * pxz) / sum(pxz),
    compos_fx = -(sum(mux_z^2 * pxz) / sum(pxz) - mux^2)
  ) %>% ungroup()

##'# Reparametrized Vaupel-Romo decomposition (same results)

#' Based on the probability to be in strata $z$ given age $x$.

ilt %>%
  group_by(x) %>%
  summarise(
    mux = Hmisc:: wtd.mean(mux_z, pz_x),
    direct_fx = Hmisc:: wtd.mean(dmux_z, pz_x),
    compos_fx = -Hmisc:: wtd.var(mux_z, pz_x, method = 'ML')
  )
